<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tallify UI Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .btn-sync { @apply bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex items-center gap-2; }
        .btn-erp { @apply bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600; }
        .btn-export { @apply bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600; }
        .material-input { @apply w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500; }
        .data-table { @apply w-full border-collapse; }
        .data-table th, .data-table td { @apply border px-4 py-2 text-left; }
        .data-table th { @apply bg-gray-100 font-semibold; }
        .page-header { @apply p-6 bg-white shadow-sm; }
        .filters-container { @apply p-4 bg-gray-50 flex items-center gap-4; }
        .data-table-wrapper { @apply p-4; }
        .loading { @apply text-center py-8 text-gray-500; }
        .error { @apply text-red-500 bg-red-50 p-4 rounded; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="page-content"></div>

    <script>
        // Mock auth service
        window.authService = {
            isAuthenticated: () => true
        };

        // Test Items Page
        class TestItemsPage {
            constructor() {
                this.config = {
                    pageName: 'Items',
                    apiEndpoint: 'http://localhost:3001/api/items',
                    entityName: 'item',
                    entityNamePlural: 'items',
                    tableColumns: [
                        { field: 'name', label: 'Name' },
                        { field: 'category', label: 'Category' },
                        { field: 'stock', label: 'Stock', align: 'text-right' },
                        { field: 'price', label: 'Price', align: 'text-right' }
                    ]
                };
                this.data = [];
                this.isLoading = false;
            }

            async init() {
                this.render();
                this.setupEventListeners();
                await this.loadData();
            }

            render() {
                document.getElementById('page-content').innerHTML = `
                    <div class="page-container-full-height">
                        <div class="page-header flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold">${this.config.pageName}</h2>
                                <p class="text-gray-600">Manage ${this.config.entityNamePlural}</p>
                            </div>
                            <div class="flex gap-3">
                                <button id="syncBtn" class="btn-sync">
                                    <span>üîÑ</span>
                                    <span>Sync From Tally</span>
                                </button>
                                <button id="addBtn" class="btn-erp">
                                    + Add ${this.config.entityName}
                                </button>
                            </div>
                        </div>
                        
                        <div class="filters-container">
                            <div class="flex-1">
                                <input type="text" id="searchInput" class="material-input" 
                                       placeholder="üîç Search ${this.config.entityNamePlural}">
                            </div>
                            <button id="exportBtn" class="btn-export">üì• Export</button>
                        </div>
                        
                        <div class="data-table-wrapper">
                            <div id="loadingDiv" class="loading hidden">Loading...</div>
                            <div id="errorDiv" class="error hidden"></div>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        ${this.config.tableColumns.map(col => 
                                            `<th class="${col.align || 'text-left'}">${col.label}</th>`
                                        ).join('')}
                                    </tr>
                                </thead>
                                <tbody id="dataTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            setupEventListeners() {
                document.getElementById('syncBtn').addEventListener('click', () => this.syncData());
                document.getElementById('addBtn').addEventListener('click', () => this.addItem());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportData());
                document.getElementById('searchInput').addEventListener('input', (e) => this.filterData(e.target.value));
            }

            async loadData() {
                this.showLoading(true);
                try {
                    const response = await fetch(`${this.config.apiEndpoint}?companyId=1`);
                    const result = await response.json();
                    if (result.success) {
                        this.data = result.data;
                        this.renderTable();
                        console.log('‚úÖ Data loaded:', this.data.length, 'items');
                    } else {
                        this.showError('Failed to load data');
                    }
                } catch (error) {
                    console.error('‚ùå Load error:', error);
                    this.showError('Network error loading data');
                } finally {
                    this.showLoading(false);
                }
            }

            async syncData() {
                const btn = document.getElementById('syncBtn');
                btn.disabled = true;
                btn.innerHTML = '<span>‚è≥</span><span>Syncing...</span>';
                
                try {
                    const response = await fetch('http://localhost:3001/api/sync/items', {
                        method: 'POST'
                    });
                    const result = await response.json();
                    if (result.success) {
                        console.log('‚úÖ Sync completed:', result.message);
                        await this.loadData();
                    }
                } catch (error) {
                    console.error('‚ùå Sync error:', error);
                    this.showError('Sync failed');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<span>üîÑ</span><span>Sync From Tally</span>';
                }
            }

            addItem() {
                const name = prompt('Item name:');
                if (!name) return;
                
                const category = prompt('Category:') || 'General';
                const stock = parseInt(prompt('Stock quantity:') || '0');
                const price = parseFloat(prompt('Price:') || '0');

                fetch('http://localhost:3001/api/items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, category, stock, price, companyId: 1 })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        console.log('‚úÖ Item added:', result.data);
                        this.loadData();
                    }
                })
                .catch(error => {
                    console.error('‚ùå Add error:', error);
                    this.showError('Failed to add item');
                });
            }

            exportData() {
                const csv = [
                    this.config.tableColumns.map(col => col.label).join(','),
                    ...this.data.map(item => 
                        this.config.tableColumns.map(col => item[col.field] || '').join(',')
                    )
                ].join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${this.config.entityNamePlural}.csv`;
                a.click();
                console.log('üì• Data exported');
            }

            filterData(searchTerm) {
                const filtered = this.data.filter(item =>
                    Object.values(item).some(value =>
                        String(value).toLowerCase().includes(searchTerm.toLowerCase())
                    )
                );
                this.renderTable(filtered);
            }

            renderTable(dataToRender = this.data) {
                const tbody = document.getElementById('dataTableBody');
                tbody.innerHTML = dataToRender.map(item => `
                    <tr class="hover:bg-gray-50">
                        ${this.config.tableColumns.map(col => 
                            `<td class="${col.align || 'text-left'}">${item[col.field] || ''}</td>`
                        ).join('')}
                    </tr>
                `).join('');
            }

            showLoading(show) {
                document.getElementById('loadingDiv').classList.toggle('hidden', !show);
            }

            showError(message) {
                const errorDiv = document.getElementById('errorDiv');
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
                setTimeout(() => errorDiv.classList.add('hidden'), 5000);
            }
        }

        // Initialize test page
        document.addEventListener('DOMContentLoaded', () => {
            const testPage = new TestItemsPage();
            testPage.init();
        });
    </script>
</body>
</html>